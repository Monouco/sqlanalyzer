{"analytics_service_endpoint_mapping": {"b": {"a": "analytics.service_endpoint_mapping", "analytics.service_endpoint_mapping": "INNER JOIN", "main": "SELECT MAX(dt) AS dt\nFROM analytics.service_endpoint_mapping) a\nINNER JOIN analytics.service_endpoint_mapping "}, "main": "SELECT b.*\nFROM b ON a.dt = b.dt),"}, "web_dev": {"s": "sku.daily_by_account", "main": "SELECT s.dt,\n       COALESCE(em.platform, 'unknown') AS platform,\n       COALESCE(service_org, 'other') AS service,\n       account\nFROM sku.daily_by_account s\nINNER JOIN mapbox_customer_data.accounts a ON s.account = a.id\nAND a.dt = '{run_date}'\nLEFT JOIN analytics_service_endpoint_mapping em ON s.sku_id = em.sku_id\nAND em.in_sku IS NOT NULL\nAND em.parent_sku IS NULL\nWHERE s.dt BETWEEN DATE_SUB('{run_date}', 29) AND '{run_date}'\nGROUP BY 1,\n         2,\n         3,\n         4), "}, "mobile_dev": {"main": "SELECT dt,\n       'mobile' AS platform,\n       CASE\n           WHEN LOWER(useragent) RLIKE '(mapboxeventsnavigation|navigation-)' THEN 'navigation'\n           WHEN LOWER(useragent) RLIKE '(mapboxeventsunity|mapbox-scenekit)' THEN 'unity'\n           WHEN LOWER(useragent) RLIKE 'mapboxtelemetry' THEN 'telemetry'\n           WHEN LOWER(useragent) RLIKE 'vision' THEN 'vision'\n           WHEN LOWER(useragent) RLIKE '(mapboxevents|mapbox-maps-)' THEN 'maps'\n           ELSE 'other'\n       END AS service,\n       OWNER AS account\nFROM sdk_events.appuserturnstile\nWHERE dt BETWEEN DATE_SUB('{run_date}', 29) AND '{run_date}'\n  AND (sdkidentifier IS NULL\n       OR sdkidentifier <> 'mapbox-gl-js')\n  AND OWNER IS NOT NULL\nGROUP BY dt,\n         'mobile',\n         CASE\n             WHEN LOWER(useragent) RLIKE '(mapboxeventsnavigation|navigation-)' THEN 'navigation'\n             WHEN LOWER(useragent) RLIKE '(mapboxeventsunity|mapbox-scenekit)' THEN 'unity'\n             WHEN LOWER(useragent) RLIKE 'mapboxtelemetry' THEN 'telemetry'\n             WHEN LOWER(useragent) RLIKE 'vision' THEN 'vision'\n             WHEN LOWER(useragent) RLIKE '(mapboxevents|mapbox-maps-)' THEN 'maps'\n             ELSE 'other'\n         END,\n         OWNER), "}, "studio_dev": {"main": "SELECT dt,\n       'web' AS platform,\n       'studio' AS service,\n       user_id AS account\nFROM mapbox_customer_data.segment_tracks\nWHERE dt BETWEEN DATE_SUB('{run_date}', 29) AND '{run_date}'\n  AND event_text IN ('Finished an Upload',\n                     'Published a style',\n                     'Created a style',\n                     'Added add a map campaign to their account',\n                     'Created cartogram style',\n                     'Style editor updated stylesheet layer')\nGROUP BY dt,\n         'web',\n         'studio',\n         user_id), "}, "web_mobile_studio": {"main": "SELECT dt,\n       platform,\n       service,\n       account\nFROM web_dev\nUNION ALL\nSELECT dt,\n       platform,\nUNION ALL\nSELECT dt,\n       platform, "}, "mau_cube": {"a": "web_mobile_studio", "main": "SELECT COALESCE(a.platform, 'other') AS platform,\n       COALESCE(a.service, 'unknown') AS service,\n       COUNT(DISTINCT a.account) AS num_devs,\n       COUNT(DISTINCT CASE\n                          WHEN b.account IS NOT NULL THEN NULL\n                          ELSE a.account\n                      END) AS num_devs_xstudio_only\nFROM web_mobile_studio a\nLEFT JOIN\n  (SELECT account,\n          CONCAT_WS(',', COLLECT_SET(LOWER(service))) AS service\n   FROM web_mobile_studio\n   GROUP BY account) b ON a.account = b.account\nAND b.service = 'studio'\nGROUP BY COALESCE(a.platform, 'other'),\n         COALESCE(a.service, 'unknown') WITH CUBE), "}, "wau_cube": {"a": "web_mobile_studio", "main": "SELECT COALESCE(a.platform, 'other') AS platform,\n       COALESCE(a.service, 'unknown') AS service,\n       COUNT(DISTINCT a.account) AS num_devs,\n       COUNT(DISTINCT CASE\n                          WHEN b.account IS NOT NULL THEN NULL\n                          ELSE a.account\n                      END) AS num_devs_xstudio_only\nFROM web_mobile_studio a\nLEFT JOIN\n  (SELECT account,\n          CONCAT_WS(',', COLLECT_SET(LOWER(service))) AS service\n   FROM web_mobile_studio\n   WHERE dt BETWEEN DATE_SUB('{run_date}', 6) AND '{run_date}'\n   GROUP BY account) b ON a.account = b.account\nAND b.service = 'studio'\nWHERE a.dt BETWEEN DATE_SUB('{run_date}', 6) AND '{run_date}'\nGROUP BY COALESCE(a.platform, 'other'),\n         COALESCE(a.service, 'unknown') WITH CUBE), "}, "dau_cube": {"main": "SELECT COALESCE(a.platform, 'other') AS platform,\n       COALESCE(a.service, 'unknown') AS service,\n       COUNT(DISTINCT a.account) AS num_devs,\n       COUNT(DISTINCT CASE\n                          WHEN b.account IS NOT NULL THEN NULL\n                          ELSE a.account\n                      END) AS num_devs_xstudio_only\nFROM web_mobile_studio a\nLEFT JOIN\n  (SELECT account,\n          CONCAT_WS(',', COLLECT_SET(LOWER(service))) AS service\n   FROM web_mobile_studio\n   WHERE dt = '{run_date}'\n   GROUP BY account) b ON a.account = b.account\nUNION ALL "}, "main": {"main": "SELECT '1d' AS aggregation,\n       COALESCE(platform, '_all') AS platform,\n       COALESCE(service, '_all') AS service,\n       num_devs,\n       num_devs_xstudio_only\nFROM dau_cube "}}